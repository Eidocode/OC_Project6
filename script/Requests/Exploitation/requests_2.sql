-- --------------------------------------------------------------------------
-- Récupérer les coordonnées de tous les clients qui ont reçu leur commande
-- --------------------------------------------------------------------------

SELECT 
    `order`.number AS "# Order", state.order_state AS "Order State", 
    user.title AS "Title", user.lastname AS "Lastname", user.firstname AS "Firstname",
    contact.phone_number AS "Phone", contact.street_number AS "# Street", 
    contact.street_name AS "Street", contact.postal_code AS "Postal code", contact.city AS "City"
FROM 
    `order`
INNER JOIN state ON 
    state.id = `order`.state_id
INNER JOIN customer ON 
    customer.id = `order`.customer_id
INNER JOIN user ON 
    user.id = customer.user_id
INNER JOIN contact ON 
    contact.id = customer.contact_id
WHERE 
    state.id = 5;

-- ------------------------------------------------
-- Récupérer le détail d'une commande d'un client
-- ------------------------------------------------

SELECT 
    `order`.number AS "# Order", user.title AS "Title", 
    user.lastname AS "Lastname", user.firstname AS "Firstname", 
    pizza.name AS "Pizza", pizza.unit_price_ht AS "Unit Price HT", 
    item.quantity AS "Qty"
FROM 
    `order`
INNER JOIN customer ON 
    customer.id = `order`.customer_id
INNER JOIN user ON 
    user.id = customer.user_id
INNER JOIN item ON 
    item.order_number = `order`.number
INNER JOIN pizza ON 
    pizza.id = item.pizza_id
WHERE 
    `order`.number = 98;

-- ----------------------------------------
-- Afficher le détail des factures payées
-- ----------------------------------------

SELECT 
    bill.order_number AS "# Bill", user.lastname AS "Lastname", 
    user.firstname AS "Firstname",
    payment_type.type AS "Payment type",
    SUM(item.quantity*pizza.unit_price_ht) AS "Total HT",
    bill.rate_vat100 AS "TVA",
    cast(SUM(item.quantity*pizza.unit_price_ht) + 
          SUM(item.quantity*pizza.unit_price_ht) * bill.rate_vat100 / 100 
           AS decimal(5,2)) AS "Total TTC",
    restaurant.name AS "Restaurant"
FROM 
    bill
INNER JOIN payment_type ON
    payment_type.id = bill.payment_type_id
INNER JOIN `order`ON 
    `order`.number = bill.order_number
INNER JOIN customer ON 
    customer.id = `order`.customer_id
INNER JOIN user ON 
    user.id = customer.user_id 
INNER JOIN item ON 
    item.order_number = `order`.number 
INNER JOIN pizza ON 
    pizza.id = item.pizza_id 
INNER JOIN restaurant ON 
    restaurant.id = bill.restaurant_id
WHERE 
    bill.payment_type_id != 4 
GROUP BY 
    bill.order_number
ORDER BY
    restaurant.id;

-- -----------------------------------------------------------
-- Afficher le détail de toutes les factures d'un restaurant
-- -----------------------------------------------------------

SELECT 
    bill.order_number AS "# Bill", user.lastname AS "Lastname", 
    user.firstname AS "Firstname",
    payment_type.type AS "Payment type",
    SUM(item.quantity*pizza.unit_price_ht) AS "Total HT",
    bill.rate_vat100 AS "TVA",
    cast(SUM(item.quantity*pizza.unit_price_ht) + 
          SUM(item.quantity*pizza.unit_price_ht) * bill.rate_vat100 / 100 
           AS decimal(5,2)) AS "Total TTC",
    restaurant.name AS "Restaurant"
FROM 
    bill
INNER JOIN payment_type ON
    payment_type.id = bill.payment_type_id
INNER JOIN `order`ON 
    `order`.number = bill.order_number
INNER JOIN customer ON 
    customer.id = `order`.customer_id
INNER JOIN user ON 
    user.id = customer.user_id 
INNER JOIN item ON 
    item.order_number = `order`.number 
INNER JOIN pizza ON 
    pizza.id = item.pizza_id 
INNER JOIN restaurant ON 
    restaurant.id = bill.restaurant_id
WHERE
    restaurant.id = 2
GROUP BY 
    bill.order_number;

-- --------------------------------------------------------------------------
-- Récupérer login, mail et rôle de tous les employés d'un restaurant donné
-- --------------------------------------------------------------------------

SELECT 
    user.login AS "Login", user.email AS "Email", role.role AS "Role", 
    restaurant.name AS "Restaurant"
FROM 
    employee
INNER JOIN user ON 
    user.id = employee.user_id
INNER JOIN role ON 
    role.id = employee.role_id
INNER JOIN restaurant ON 
    restaurant.id = employee.restaurant_id
WHERE 
    restaurant.id = 3
ORDER BY 
    role.id;

-- ------------------------------------------------------------
-- Afficher le stock de tous les ingrédients d'un restaurant
-- ------------------------------------------------------------

SELECT 
    ingredient.name AS "Ingredient", stock.quantity AS "Stock (gr.)", 
    restaurant.name AS "Restaurant"
FROM 
    stock
INNER JOIN ingredient ON 
    ingredient.id = stock.ingredient_id
INNER JOIN restaurant ON 
    restaurant.id = stock.restaurant_id
WHERE 
    restaurant.id = 1;

-- -----------------------------------------------
-- Afficher toutes les commandes d'un restaurant
-- -----------------------------------------------

SELECT 
    `order`.number AS "Order", state.order_state AS "State", 
    payment_type.type AS "Payment type", restaurant.name AS "Restaurant"
FROM 
    `order`
INNER JOIN state ON 
    state.id = `order`.state_id
INNER JOIN bill ON 
    bill.order_number = `order`.number
INNER JOIN payment_type ON 
    payment_type.id = bill.payment_type_id
INNER JOIN restaurant ON 
    restaurant.id = bill.restaurant_id
WHERE 
    restaurant.id = 4
ORDER BY 
    `order`.number;

-- ---------------------------------------------------------------------
-- Afficher toutes les factures payées par CB et le restaurant associé
-- ---------------------------------------------------------------------

SELECT 
    bill.order_number AS "# Bill", payment_type.type AS "Payment type", 
    bill.date AS "Date", restaurant.name AS "Restaurant"
FROM 
    bill
INNER JOIN payment_type ON 
    payment_type.id = bill.payment_type_id
INNER JOIN restaurant ON 
    restaurant.id = bill.restaurant_id
WHERE 
    payment_type.id = 1;

-- ---------------------------------------------------
-- Récupérer le détail d'une commande payée en ligne
-- ---------------------------------------------------

SELECT 
    `order`.number AS "# Order", `order`.paid_online AS "Paid online", 
    `order`.added_date AS "Date", pizza.name AS "Pizza", 
    pizza.unit_price_ht AS "Unit Price HT", item.quantity AS "Qty"
FROM 
    item
INNER JOIN `order` ON 
    `order`.number = item.order_number
INNER JOIN pizza ON 
    pizza.id = item.pizza_id
WHERE 
    `order`.paid_online = 1 
AND 
    `order`.number = 40;

-- --------------------------------------------------------------------------
-- Sélectionner les pizzas, prix HT et recettes des produits qui comportent 
-- des champignons
-- --------------------------------------------------------------------------

SELECT 
    ingredient.name AS "Ingredient", pizza.name AS "Pizza", 
    pizza.unit_price_ht AS "Unit price", reminder.description AS "Recipe"
FROM 
    pizza 
INNER JOIN pizza_ingredient ON 
    pizza_ingredient.pizza_id = pizza.id
INNER JOIN ingredient ON 
    ingredient.id = pizza_ingredient.ingredient_id
INNER JOIN reminder ON
    reminder.pizza_id = pizza.id
WHERE 
    ingredient.id = 3;